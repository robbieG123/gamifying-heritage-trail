<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <title>Dundee Ghost Trail</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Averia Sans Libre' rel='stylesheet' href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
     crossorigin=""/>
     <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
     integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
     crossorigin=""></script>
  </head>
  <body>
    <main>
        <div class="container text-center">
            <h1>Ghost Map</h1>

            <div id="map"></div>

            <div class="row d-flex position-relative">
                <div id="home" style="display: block">
                    <div class="col" id="box">
                        <a  href="GhostTrailHomepage.html" class="stretched-link">HOME</a>
                    </div>
                </div>
                <div id="catch" style="display: none;">
                    <div class="col" id="box">
                        <a  href="CatchScreen.html" class="stretched-link">CATCH</a>
                    </div>
                </div>

            </div>
        </div>
    </main>
  </body>
</html>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js">//leafletAPI for the map</script>


<script>
    //sessionStorage.clear();
    // Geolocation Code from https://www.section.io/engineering-education/how-to-build-a-real-time-location-tracker-using-leaflet-js/
    //creates the map
    var map_init = L.map('map', {
            center: [56.461693858992, -2.9584546440361428],
            zoom: 15
        });
        circleRadius = 50;
        // creates open street map layer
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map_init);
        //finds current position of users device
        L.Control.geocoder().addTo(map_init);
        if (!navigator.geolocation) {
            console.log("Your browser doesn't support geolocation feature!")
        } else {
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(getPosition)   
            }, 5000);
        };
        
        var marker, circle, lat, long, accuracy;

        function getPosition(position) {
            

            lat = position.coords.latitude
            long = position.coords.longitude
            accuracy = position.coords.accuracy

            if (marker) {
                map_init.removeLayer(marker)
            }

            if (circle) {
                map_init.removeLayer(circle)
            }
            var latlng = L.latLng([lat, long])
            //console.log("yes!");
            marker = L.marker(latlng)
            circle = L.circle(latlng, { radius: accuracy })

            var featureGroup = L.featureGroup([marker, circle]).addTo(map_init);

            //map_init.fitBounds(featureGroup.getBounds())
            

            console.log("Your coordinate is: Lat: " + lat + " Long: " + long + " Accuracy: " + accuracy);
            for (let i = 0; i < circles.length; i++) {
                var circleLatlng = L.latLng(circles[i])
                
                isMarkerInsideCircle(latlng, circleLatlng, circleRadius, i, circles[i])
            }
            
        }

    var caughtGhosts = [];

    
    

    var circles = [[56.461693858992, -2.9584546440361428, ]//HMS Unicorn
                    , [56.45754264075013, -2.967002643977912]//V&A
                    , [56.4473698, -2.9855801] //[test]Middle of the River
                    , [56.4473698, -2.9855801] //[test]Middle of the River2
                    , [56.45784893512836, -2.974880741263478]//[test] My flat
                    , [56.45696385016537, -2.9688912702269348]// Discovery
                    , [56.45797604519422, -2.9743101952862383]// DMA Headquarters
                    , [56.45840442854417, -2.9824555984409122]// Dundee Uni
                    , [56.461442520320624, -2.983517639643721]// Verdant Works
                    , [56.46241918920453, -2.9709972375674463]// McManus Galleries
                    , [56.46489142163189, -2.9641433607646053]// Wishart's Arch
                    ];

    const locationData = [["HMS Unicorn", "The HMS Unicorn is the oldest surviving ship in Scotland. It was launched in 1824 after being built in Chatham Dockyard in Kent. The ship was built for war however, was launched just after the end of the naval wars against Napolean so was never used in real combat. Instead, it was kept in 'ordinary' as a reserve ship until 1873 when it was sent to Dundee to be used as a training ship, which it carried out for nearly 100 years until 1968 when it was considered to be scrapped. However, The Unicorn Preservation Society (UPS) was formed and managed to prevent this from happening and to keep it as a landmark for the city, where it stays today", "https://upload.wikimedia.org/wikipedia/commons/thumb/7/75/HMS_Unicorn%2C_Dundee_002.jpg/450px-HMS_Unicorn%2C_Dundee_002.jpg"]
                        ,["The V&A Dundee", "The V&A Dundee was opened on the 15th September 2018, becoming the first design museum in Scotland and the first Victoria and Albert museum outside London. The design of the building was decided by a competition in 2010. The winner was Japanese architect, Kengo Kuma who said his design was inspired by the eastern cliff edges of Scotland. Construction started in April 2014 and cost Â£80.1 Million to complete.", "https://d363suj4pdptk4.cloudfront.net/externalApps/b4764c1e-e783-4381-aa97-e1f506037d14/conversion/sirtrevor--1072/assets/14960"]
                        ,["River Tay","This is some information about the River", "https://www.dundee.com/sites/default/files/styles/grid_wide/public/Attractions%20-%20River%20Tay.jpg?itok=6fx9VxdB"]
                        ,["River Tay 2","This is some information about the River", "https://www.dundee.com/sites/default/files/styles/grid_wide/public/Attractions%20-%20River%20Tay.jpg?itok=6fx9VxdB"]
                        ,["The Flat", "This is some information about the Flat", "https://i.pinimg.com/236x/72/c8/d3/72c8d340ec93c446169f55f105a39851--bts-pictures-scissors.jpg"]
                        ,["RMS Discovery", "This is some information about the Discovery"]
                        ,["DMA Designs HQ", "This is some information about the original DMA designs HQ", "https://i2-prod.dailyrecord.co.uk/incoming/article25805725.ece/ALTERNATES/s615b/0_DMAoffice.png"]
                        ,["Dundee University", "This is some information about the University", ""]
                        ,["Verdant Works", "This is some information about the University", ""]
                        ,["McManus Galleries", "This is some information about the University", ""]
                        ,["Wishart's Arch", "This is some information about the University", ""]]

    const quiz = [["What year was the HMS Unicorn launched?", "1815", "1824", "1853", "1877", 2]
                ,["What inspired the design of the V&A?", "Ships", "Whales", "Cliffs", "Waves", 3]
                ,["River", "1", "2","3","4",2]
                ,["River2", "1", "2","3","4",2]
                ,["The flat", "1", "2","3","4",2]
                ,["Discovery", "1", "2","3","4",2]
                ,["What game did DMA Design/Rockstar North release in 1997?", "Call of Duty", "Medal of Honour", "Grand Theft Auto", "Quake", 3]
                ,[]
                ,[]
                ,[]
    
                ,[]]

    var locationNum = sessionStorage.getItem("locationNum");
    var caughtGhosts = sessionStorage.getItem("caughtGhosts")
    sessionStorage.setItem("caughtGhosts", caughtGhosts + "/" +circles[locationNum]);
    var caughtGhosts = sessionStorage.getItem("caughtGhosts")
    console.log(caughtGhosts);
    const caughtGhostsArray = caughtGhosts.split("/");
    console.log(caughtGhostsArray);

    function placeMarkers(){

        removeMarker(locationNum, caughtGhostsArray);

        for (let i = 0; i < circles.length; i++) {
            var caught = false;
            for (let j = 0; j < caughtGhostsArray.length; j++){
                if (circles[i] == caughtGhostsArray[j]){
                    caught = true
                    console.log("caught");
                }
            }
            if (caught == false){
                L.circle(circles[i], circleRadius).addTo(map_init);
                L.marker(circles[i]).addTo(map_init);
            }
        }
    }


    function removeMarker(locationNum, caughtGhosts){
        console.log(circles[locationNum]);
        if(catchGhost.length > 0){
            for (let x = 0; x < caughtGhosts.length; x++){
                circles[locationNum] = [0, 0];
            }
        }
    }
    
    placeMarkers();


    function isMarkerInsideCircle(markerLatLng, circleCenterLatLng, circleRadius, locationNum, stringLatLng){
        // markerLatLng and circleCenterLatLng must be instance of L.latlng class.
        // you can create an instance like this L.latLng(lat, lng);
        //console.log(markerLatLng.distanceTo(circleCenterLatLng));
        //console.log(circleRadius)
        var visited = false;
        if (markerLatLng.distanceTo(circleCenterLatLng) <= circleRadius){
            for (let j = 0; j < caughtGhostsArray.length; j++){
                console.log(stringLatLng.toString());
                console.log(caughtGhostsArray[j]);
                if (stringLatLng.toString() == caughtGhostsArray[j]){
                    console.log("not there")
                    visited = true;
                }
            }
            if (visited == false){
                toggleText()
                document.getElementById("catch").onclick = catchGhost(locationNum);
                return true;
            }
            
        } else {
            return false;
        }
    }

    function toggleText() {
        var homeText = document.getElementById("home");
    if (homeText.style.display === "block") {
        homeText.style.display = "none";
    }
    
    var text = document.getElementById("catch");
    if (text.style.display === "none") {
        text.style.display = "block";
    }
    
    }

    function catchGhost(locationNum){
       

        //https://lage.us/Javascript-Pass-Variables-to-Another-Page.html
        var LatLng = circles[locationNum];
        var lat = circles[locationNum][0];
        var lng = circles[locationNum][1];

        var title = locationData[locationNum][0];
        var info = locationData[locationNum][1];
        var image = locationData[locationNum][2];

        var question = quiz[locationNum][0];
        var ans1 = quiz[locationNum][1];
        var ans2 = quiz[locationNum][2];
        var ans3 = quiz[locationNum][3];
        var ans4 = quiz[locationNum][4];
        var correct = quiz[locationNum][5];

        

        sessionStorage.setItem("locationNum", locationNum)

        sessionStorage.setItem("lat", lat);
        sessionStorage.setItem("lng", lng);
        sessionStorage.setItem("title", title);
        sessionStorage.setItem("info", info);
        sessionStorage.setItem("image", image);

        sessionStorage.setItem("question", question);
        sessionStorage.setItem("ans1", ans1);
        sessionStorage.setItem("ans2", ans2);
        sessionStorage.setItem("ans3", ans3);
        sessionStorage.setItem("ans4", ans4);
        sessionStorage.setItem("correct", correct);
        //
    }
</script>