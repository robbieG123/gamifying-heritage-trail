<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <title>Dundee Ghost Trail</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
     crossorigin=""/>
     <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
     integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
     crossorigin=""></script>
  </head>
  <body>
    <main>
        <div class="container text-center">
            <h1>Map Screen</h1>

            <div id="map"></div>

            <div class="row d-flex position-relative" >
                <div id="catch" style="display: none;">
                    <div class="col" id="box">
                        <a  href="CatchScreen.html" class="stretched-link">CATCH</a>
                    </div>
                </div>
            </div>
        </div>
    </main>
  </body>
</html>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js">//leafletAPI for the map</script>


<script>
    // Geolocation Code from https://www.section.io/engineering-education/how-to-build-a-real-time-location-tracker-using-leaflet-js/
    //creates the map
    var map_init = L.map('map', {
            center: [56.461693858992, -2.9584546440361428],
            zoom: 15
        });
        circleRadius = 50;
        // creates open street map layer
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map_init);
        //finds current position of users device
        L.Control.geocoder().addTo(map_init);
        if (!navigator.geolocation) {
            console.log("Your browser doesn't support geolocation feature!")
        } else {
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(getPosition)   
            }, 5000);
        };
        var marker, circle, lat, long, accuracy;

        function getPosition(position) {
            lat = position.coords.latitude
            long = position.coords.longitude
            accuracy = position.coords.accuracy

            if (marker) {
                map_init.removeLayer(marker)
            }

            if (circle) {
                map_init.removeLayer(circle)
            }
            var latlng = L.latLng([lat, long])
            //console.log("yes!");
            marker = L.marker(latlng)
            circle = L.circle(latlng, { radius: accuracy })

            var featureGroup = L.featureGroup([marker, circle]).addTo(map_init);

            //map_init.fitBounds(featureGroup.getBounds())

            console.log("Your coordinate is: Lat: " + lat + " Long: " + long + " Accuracy: " + accuracy);
            for (let i = 0; i < circles.length; i++) {
                var circleLatlng = L.latLng(circles[i])
                
                isMarkerInsideCircle(latlng, circleLatlng, circleRadius, i)
            }
            
        }

    
    const circles = [[56.461693858992, -2.9584546440361428, ]//HMS Unicorn
                    , [56.45754264075013, -2.967002643977912]//V&A
                    , [56.457931596431294, -2.976493584807401]//[test]Dundee Rep Theatre
                    , [56.4473698, -2.9855801]//Middle of the River
                    , [56.45784893512836, -2.974880741263478]];//[test] My flat

    const locationData = [["This is some information about the unicorn"]
                        ,["This is some information about the V&A"]
                        ,["This is some information about the Rep"]
                        ,["This is some information about the River"]
                        ,["This is some information about the Flat"]]

    for (let i = 0; i < circles.length; i++) {
        
        L.circle(circles[i], circleRadius).addTo(map_init);
        L.marker(circles[i]).addTo(map_init);
    }
    

    function isMarkerInsideCircle(markerLatLng, circleCenterLatLng, circleRadius, locationNum){
        // markerLatLng and circleCenterLatLng must be instance of L.latlng class.
        // you can create an instance like this L.latLng(lat, lng);
        console.log(markerLatLng.distanceTo(circleCenterLatLng));
        console.log(circleRadius)
        if (markerLatLng.distanceTo(circleCenterLatLng) <= circleRadius){
            console.log("yes!");
            toggleText()
            document.getElementById("catch").onclick = catchGhost(locationNum);
            return true;
        } else {
            console.log("no!")
            return false;
        }
    }

    function toggleText() {
    var text = document.getElementById("catch");
    if (text.style.display === "none") {
        text.style.display = "block";
    }
    }

    function catchGhost(locationNum){
        //https://lage.us/Javascript-Pass-Variables-to-Another-Page.html
        var LatLng = circles[locationNum];
        var lat = circles[locationNum][0]
        var lng = circles[locationNum][1]
        var info = locationData[locationNum]
        sessionStorage.setItem("lat", lat);
        sessionStorage.setItem("lng", lng);
        sessionStorage.setItem("info", info);
    }
</script>