<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">    <title>Dundee Ghost Trail</title>
    <title>Dundee Ghost Trail</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Averia Sans Libre' rel='stylesheet' href="style.css">
    <link href='https://fonts.googleapis.com/css?family=Jockey One' rel='stylesheet' href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
     crossorigin=""/>
     <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
     integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
     crossorigin=""></script>
  </head>
  <body>
    <main>
        <div class="container text-center">
            <h1>Ghost Map</h1>

            <div id="map"></div>
            <p style="margin-bottom: 0; padding-bottom: 0; padding-top: 5px;">Travel to a ghost. once you're in its vicinity you can catch it.</p>
            <div class="row" style=" margin-top:0; margin-bottom: 10px;">
                
                <div id="catch" style="display: none;">
                    <div class="col" id="box" style="margin-top:10px;">
                        <a  href="CatchScreen.html" class="stretched-link" >CATCH</a>
                    </div>
                </div>

            </div>
        </div>
    </main>
  </body>
  <nav class="navbar fixed-bottom bg-body-tertiary">
    <div class="container">
      <a class="navbar-brand" href="GhostTrailHomepage.html">
        <img src="Pictures\home.png" alt="Logo" width="36" height="36" class="d-inline-block align-text-top">
      </a>
      <a class="navbar-brand" href="GhostTrailMapScreen.html">
        <img src="Pictures\marker-dark.png" alt="Logo" width="36" height="36" class="d-inline-block align-text-top">
      </a>
      <a class="navbar-brand" href="GhostScreen.html">
        <img src="Pictures\ghost.png" alt="Logo" width="42" height="42" class="d-inline-block align-text-top">
      </a>
      <a class="navbar-brand" href="InfoScreen.html">
        <img src="Pictures\info.png" alt="Logo" width="36" height="36" class="d-inline-block align-text-top">
      </a>
    </div>
  </nav>
</html>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js">//leafletAPI for the map</script>


<script>
    //sessionStorage.clear();
    // Geolocation Code from https://www.section.io/engineering-education/how-to-build-a-real-time-location-tracker-using-leaflet-js/
    //creates the map

    var redIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var ghostIcon = new L.Icon({
        iconUrl: 'https://cdn.pixabay.com/photo/2012/04/16/12/53/ghost-35852_960_720.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [41, 54],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var map_init = L.map('map', {
            center: [56.461693858992, -2.9584546440361428],
            zoom: 13
        });
        circleRadius = 50;
        // creates open street map layer
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map_init);
        //finds current position of users device
        L.Control.geocoder().addTo(map_init);
        if (!navigator.geolocation) {
            console.log("Your browser doesn't support geolocation feature!")
        } else {
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(getPosition)   
            }, 2000);
        };
        
        var marker, circle, lat, long, accuracy;

        // getPosition() gets the users current position and checks if it is inside any of the circles
        function getPosition(position) {
            
            lat = position.coords.latitude //latitiude of users position
            long = position.coords.longitude //longitude of users position
            accuracy = position.coords.accuracy //accuracy of users coordinates

            if (marker) { // if the marker has already been placed, removes it for the new one to be placed
                map_init.removeLayer(marker)
            }

            if (circle) {
                map_init.removeLayer(circle)
            }

            
            if (circles.length > 10){
                circles.pop()
            }

            
           

            var latlng = L.latLng([lat, long]); // creates a LatLng object from the coordinates
            circles.push(latlng)
            console.log(circles[12])
            marker = L.marker(latlng,{icon: redIcon}).addTo(map_init); // declares marker at the location

           // var featureGroup = L.featureGroup([marker, circle]).addTo(map_init)

           // map_init.fitBounds(featureGroup.getBounds())
            
            //checks if the user is inside any of the circles
            for (let i = 0; i < circles.length; i++) { 
                var circleLatlng = L.latLng(circles[i])
                if(isMarkerInsideCircle(latlng, circleLatlng, circleRadius, i, circles[i])){
                    break;
                }
            }
            
        }

    var caughtGhosts = [];

    var caughtLocations = [];
    

    var circles = [[56.461693858992, -2.9584546440361428, ]//HMS Unicorn
                    , [56.45754264075013, -2.967002643977912]//V&A
                    , [56.4473698, -2.9855801] //[test]Middle of the River
                    , [56.4473698, -2.9855801] //[test]Middle of the River2
                    , [56.45696385016537, -2.9688912702269348]// Discovery
                    , [56.45797604519422, -2.9743101952862383]// DMA Headquarters
                    , [56.45840442854417, -2.9824555984409122]// Dundee Uni
                    , [56.461442520320624, -2.983517639643721]// Verdant Works
                    , [56.46241918920453, -2.9709972375674463]// McManus Galleries
                    , [56.46489142163189, -2.9641433607646053]// Wishart's Arch
                    ];

    const locationData = [["HMS Unicorn", "The HMS Unicorn is the oldest surviving ship in Scotland. It was launched in 1824 after being built in Chatham Dockyard in Kent. The ship was built for war however, was launched just after the end of the naval wars against Napolean so was never used in real combat. Instead, it was kept in 'ordinary' as a reserve ship until 1873 when it was sent to Dundee to be used as a training ship, which it carried out for nearly 100 years until 1968 when it was considered to be scrapped. However, The Unicorn Preservation Society (UPS) was formed and managed to prevent this from happening and to keep it as a landmark for the city, where it stays today", "https://upload.wikimedia.org/wikipedia/commons/thumb/7/75/HMS_Unicorn%2C_Dundee_002.jpg/450px-HMS_Unicorn%2C_Dundee_002.jpg"]
                        ,["The V&A Dundee", "The V&A Dundee was opened on the 15th September 2018, becoming the first design museum in Scotland and the first Victoria and Albert museum outside London. The design of the building was decided by a competition in 2010. The winner was Japanese architect, Kengo Kuma who said his design was inspired by the eastern cliff edges of Scotland. Construction started in April 2014 and cost Â£80.1 Million to complete.", "https://d363suj4pdptk4.cloudfront.net/externalApps/b4764c1e-e783-4381-aa97-e1f506037d14/conversion/sirtrevor--1072/assets/14960"]
                        ,["River Tay","This is some information about the River", "https://www.dundee.com/sites/default/files/styles/grid_wide/public/Attractions%20-%20River%20Tay.jpg?itok=6fx9VxdB"]
                        ,["River Tay 2","This is some information about the River", "https://www.dundee.com/sites/default/files/styles/grid_wide/public/Attractions%20-%20River%20Tay.jpg?itok=6fx9VxdB"]
                        ,["RRS Discovery", "The 1901 British National Antarctic Expedition was the vision of Sir Clements Markham, President of the Royal Geographical Society. His goal was to send a crew to the Antarctic as a scientific expedition. By 1900 he had raised the funds to complete the task. The RRS Discovery was built by the Dundee Shipbuilders Company in Dundee as the ship to take the crew on the journey. Its design was based Dundee whaler ships with some modifications to make it suitable for the task. The man who was picked to lead the expedition was 33 year old Captain Robert Falcon Scott, an English Royal Navy officer who hand-picked the fourty-eight men for the ships crew. They were a mixture of merchant and naval seamen along with scientists consisisting of a Physicist, Geologist, Marine Biologist, Botanist and a Zoologist. The ship was launched in 1901 and five months later, it began it's journey to the Antarctic. The crew made many scientific breakthroughs on the expedition and managed to travel further south than anyone else had done ever before them. On the 10th September 104, the ship returned to Britain, 1131 days after its departure.", "https://www.nationalhistoricships.org.uk/sites/default/files/data/nrhv/vessels/39_RRSDISCOVERY_5.jpg"]
                        ,["DMA Designs Original HQ", "DMA Designs (currently known as Rockstar North), is a video game development company. Founded by David Jones, their original headquarters were located here just above Wee Mexico. The company was formed in 1987 making games for the Amiga, Atari ST and Commodore 64. In 1991 they released Lemmings which was an international success. Following this, they released Grand Theft Auto in 1997 which started a hugely successful series, the most recent (Grand Theft Auto V) selling over 170 million copies worldwide. The company was bought by Take-Two Interactive and in 2001, they were renamed Rockstar North. Their current headquarters are now located in Edinburgh", "https://i2-prod.dailyrecord.co.uk/incoming/article25805725.ece/ALTERNATES/s615b/0_DMAoffice.png"]
                        ,["University of Dundee", "The University of Dundee was founded in 1881 as a constituent college of the University of St Andrews after a donation of Â£140,000 was made by the Baxter family who made their money from the Jute mills of the city. In 1967, after a major expansion, it became an independent university and was formally established. The first Chancellor of the University was the Queen Mother, who the current School of Computing building is named after. Today, the University of Dundee has over 16000 students and is ranked in the top 250 universities in the world", "https://miro.medium.com/max/1170/1*_vwgoiVfHBxkHcW6w2Jtgw.jpeg"]
                        ,["Verdant Works", "The Verdant works is a former jute mill that was once the heart of Dundee's industry. The mill was built in 1833 and was originally a flax processor but in the 1840's they switched production to jute. Jute is one of the three J's that make up dundee's industrial heritage along with Jam and Journalism. By 1864, the mill had three steam engines with 70 power looms and 2,800 spindles. The mill employed 500 people to spin and prepare the jute which was sent across the road to a seperate factory on Milne Street to be weaved. In 1889, Verdant Works stopped being a true textile manufacturer and in 1893 was bought by Alexander Thomson and Sons to recycle jute waste into flock for mattresses and furniture. Overtime, more factories were being opened in India as this was closer to where the jute comes from which lead to a decline in Dundee jute processing. Verdant Works was transformed into a public museum in 1996 and still stands today.", "https://ichef.bbci.co.uk/news/464/mcs/media/images/68568000/jpg/_68568187_verdant_rockwell_works_dht.jpg"]
                        ,["McManus Gallery", "The McManus Gallery was built in 1867, designed by the architect George Gilbert Scott originally as a memorial to Pince Albert and was called the Albert Institute. In 1959, the city corporation took over as administrators and was given a refurbishment along with a name change to the McManus Galleries. This commemorates Maurice McManus who was the Lord Provost of Dundee from 1962 to 1967. In 2010 it was refurbished again and renamed to The McManus: Dundee's Art Gallery and Museum. It currently contains 8 galleries on 2 floors with exhibits ranging from art to life 400 million years ago.", "https://upload.wikimedia.org/wikipedia/commons/d/d4/McManus_Galleries_Dundee_2017.jpg"]
                        ,["Wishart's Arch", "Wishart Arch, initially called the Eastgate and commonly known as the Cowgate, was a passage which led through the defensive stone wall that surrounded Dundee. The arch is the only surviving part of the wall and got its name and fame from George Wishart. Wishart was a Scottish Protestant Reformer who, during the plague of 1544, gave a sermon to the infected that were quarantined on the other side by standing on the balustrade by the wall. 2 years later, Wishart was burned at the stake in St. Andrews for being a heretic where a memorial for him and three other martyrs stands.", "https://usercontent.one/wp/www.citylifedundee.com/wp-content/uploads/2015/07/001_59_wishart-arch-main.jpg"]
                        ,["RRS Discovery", "The 1901 British National Antarctic Expedition was the vision of Sir Clements Markham, President of the Royal Geographical Society. His goal was to send a crew to the Antarctic as a scientific expedition. By 1900 he had raised the funds to complete the task. The RRS Discovery was built by the Dundee Shipbuilders Company in Dundee as the ship to take the crew on the journey. Its design was based Dundee whaler ships with some modifications to make it suitable for the task. The man who was picked to lead the expedition was 33 year old Captain Robert Falcon Scott, an English Royal Navy officer who hand-picked the fourty-eight men for the ships crew. They were a mixture of merchant and naval seamen along with scientists consisisting of a Physicist, Geologist, Marine Biologist, Botanist and a Zoologist. The ship was launched in 1901 and five months later, it began it's journey to the Antarctic. The crew made many scientific breakthroughs on the expedition and managed to travel further south than anyone else had done ever before them. On the 10th September 104, the ship returned to Britain, 1131 days after its departure.", "https://www.nationalhistoricships.org.uk/sites/default/files/data/nrhv/vessels/39_RRSDISCOVERY_5.jpg"]]

    const quiz = [["What year was the HMS Unicorn launched?", "1815", "1824", "1853", "1877", 2]
                ,["What inspired the design of the V&A?", "Ships", "Whales", "Cliffs", "Waves", 3]
                ,["River", "1", "2","3","4",2]
                ,["River2", "1", "2","3","4",2]
                ,["The flat", "1", "2","3","4",2]
                ,["Which of these was NOT a scientist on the RRS Discovery", "Zoologist", "Marine Biologist","Botanist","Chemist",4]
                ,["What game did DMA Design/Rockstar North release in 1997?", "Call of Duty", "Medal of Honour", "Grand Theft Auto", "Quake", 3]
                ,["Who was the first chancellor of the University of Dundee?", "The Queen Mother", "The Queen", "Prince Philip", "Prince Charles", 1]
                ,["Which of these is NOT one of the three J's of Dundee?", "Jute", "Jam", "Jeans", "Journalism", 3]
                ,["Who was Maurice McManus?", "Mayor", "Lord Provost", "Architect", "King", 2]
                ,["What is Wishart Arch also known as?", "Wellgate", "Cowgate", "Overgate", "Nethergate", 2]
                ,["Which of these was NOT a scientist on the RRS Discovery", "Zoologist", "Marine Biologist","Botanist","Chemist",4]];
    
    // uses sessionStorage to add the most recently visited location to caughtGhostsArray. If no ghosts have been caught 'null/undefined' is added to array
    var quizComplete = sessionStorage.getItem("quizComplete");
    console.log(quizComplete);
    var locationNum = sessionStorage.getItem("locationNum"); //index of the most recently visited location
    var caughtGhosts = sessionStorage.getItem("caughtGhosts"); //string of all caught ghost coordinates
    var caughtLocations = sessionStorage.getItem("caughtLocations");
    if (quizComplete != "false"){ //checks if the user has completed the quiz
        console.log("quiz complete");
        sessionStorage.setItem("caughtGhosts", caughtGhosts + "/" +circles[locationNum]); //adds most recently visited location to sessionStorage caughtGhosts
    }
    var caughtGhosts = sessionStorage.getItem("caughtGhosts"); //gets the updated caughtGhosts string for use
    const caughtGhostsArray = caughtGhosts.split("/"); //splits the string by '/' and inputs them into the caughtGhostsArray
    




    //placeMarkers() places the markers of all unvisited locations defined in the circles array
    function placeMarkers(){
        console.log("hello")
        if (quizComplete != "false"){
            removeMarker(locationNum, caughtGhostsArray);   //changes all visited markers from the circles array to [0, 0]
        }
        
        for (let i = 0; i < circles.length; i++) {  //loops for the length of circles array
            var caught = false; //declares that the ghost has not been caught
            for (let j = 0; j < caughtGhostsArray.length; j++){ //loops for length of caughtGhostsArray
                if (circles[i] == caughtGhostsArray[j]){    //checks if the current location has already been caught (is in the caughtGhostsArray)
                    caught = true // if already been caught. caught = true
                }
            }
            if (caught == false){   //if the ghost hasnt already been caught
                L.circle(circles[i], circleRadius).addTo(map_init); //place circle at the location
                L.marker(circles[i],{icon: ghostIcon}).addTo(map_init);   //place circle at the location
            }
        }
    }

    function removeMarker(locationNum, caughtGhosts){

        console.log(circles[locationNum]);
        if(catchGhost.length > 0){
            for (let x = 0; x < caughtGhosts.length; x++){
                circles[locationNum] = [0, 0];
            }
        }
    }
    
    placeMarkers(); //calls the placeMarkers() function
 
    // isMarkerInsideCircle() checks if the user is inside any of the marker circles and if the ghost has been caught at that location before
    function isMarkerInsideCircle(markerLatLng, circleCenterLatLng, circleRadius, locationNum, stringLatLng){

        var visited = false; //variable that declares whether this marker has been visited (Initially false)
        if (markerLatLng.distanceTo(circleCenterLatLng) <= circleRadius){ //checks if the distance from the users location to the center of the circle is less than the radius of the circle
            for (let j = 0; j < caughtGhostsArray.length; j++){ //loops for the length of the session variable caughtGhostsArray
                if (stringLatLng.toString() == caughtGhostsArray[j]){   //checks if the coordinates of the marker has already been caught and is in the caughtGhostsArray
                    visited = true; //if it has been caught, then visited is true
                }
            }
            if (visited == false){ //if the marker hasn't been caught
                console.log(locationNum)
                toggleText()    //change the button text from 'HOME' to 'CATCH'
                document.getElementById("catch").onclick = function() {catchGhost(locationNum)}; //When catch button is clicked, call the catchGhost function

                return true;
            }
        } else {
            return false;
        }
    }

    // toggleText() changes the button on MapScreen from home to catch and vice versa
    function toggleText() {

        //changes catch to home
        var text = document.getElementById("catch");
        if (text.style.display === "none") {
            text.style.display = "block";
        }
    
    }

    //catchGhost() triggers when the user presses the catch button when they're near a marker. It pushes all the data of that location to session storage
    function catchGhost(locationNum){
        //Coordinate data
        var LatLng = circles[locationNum];
        var lat = circles[locationNum][0];
        var lng = circles[locationNum][1];

        //Location data
        var title = locationData[locationNum][0];
        var info = locationData[locationNum][1];
        var image = locationData[locationNum][2];

        //Quiz data
        var question = quiz[locationNum][0];
        var ans1 = quiz[locationNum][1];
        var ans2 = quiz[locationNum][2];
        var ans3 = quiz[locationNum][3];
        var ans4 = quiz[locationNum][4];
        var correct = quiz[locationNum][5];

        var locationName = locationData[locationNum][0];

        sessionStorage.setItem("locationNum", locationNum)
        sessionStorage.setItem("lat", lat);
        sessionStorage.setItem("lng", lng);

        sessionStorage.setItem("title", title);
        sessionStorage.setItem("info", info);
        sessionStorage.setItem("image", image);

        sessionStorage.setItem("question", question);
        sessionStorage.setItem("ans1", ans1);
        sessionStorage.setItem("ans2", ans2);
        sessionStorage.setItem("ans3", ans3);
        sessionStorage.setItem("ans4", ans4);
        sessionStorage.setItem("correct", correct);

        sessionStorage.setItem("locationName", locationName);

        sessionStorage.setItem("quizComplete", "false");
    }
</script>